
# خطة إعادة هيكلة الـ Flow + إصلاح الأخطاء

## المشاكل الحالية

1. **UI Freeze عند إعادة المشاهد**: الـ EnhancedDialogue بيسيب overlay عالق بعد الإغلاق
2. **CTA بيوّدي مكان غلط**: الزر "ابدأ من البيانات" بيروح الصالة بدل البيانات (bug في handleCTA - بيقرأ الـ phase اللي بعدها مش الحالية)
3. **الترتيب مش صح**: أدلة الضوضاء (N1, N2) ظاهرة بدري في غرفة الأدلة، وما فيش أدلة حقيقية
4. **الـ Hub صفحة منفصلة**: اللاعب مضطر يرجع للـ Hub كل مرة

## التصميم الجديد (حسب طلبك)

### المبدأ الأساسي: "الـ Hub موزع في كل مكان"

بدل ما الـ Hub صفحة مستقلة، هيتوزع على كل الشاشات كـ overlay ثابت:
- **فوق**: شريط الفرضيات المختارة (4 بطاقات صغيرة)
- **يمين تحت**: دفتر الملاحظات (floating button - موجود أصلا)
- **تحت**: أزرار الغرف (بيانات / أدلة / صالة / مكتب) - بس بيعرض اللي اتفتح فقط
- **وسط**: زر "تابع التحليل" + رسالة سياقية - يظهر في نفس الشاشة بعد ما اللاعب يخلص المطلوب

### الـ Flow الجديد (بعد اختيار الفرضيات)

```text
اختيار 4 فرضيات
    |
    v
رسالة: "ابدأ بالبيانات، خد فكرة عامة عن اللي اتغير الأسبوع ده"
زر: "تابع التحليل" -> يروح direct على غرفة البيانات
    |
    v
غرفة البيانات (D1 + D2 مفتوحين)
   اللاعب يفتح الأدلة
   بعد ما يفتحهم: يظهر زر + رسالة في نفس الشاشة
   رسالة: "ممكن تقابل فريق العمل... اسمع ملاحظاتهم"
   زر: "تابع التحليل"
    |
    v
الصالة (خالد + نورة مفتوحين)
   بعد المقابلات: رسالة + زر
   رسالة: "اتفتح ملف جديد في غرفة الأدلة"
   زر: "تابع التحليل"
    |
    v
... وهكذا لكل مرحلة
```

**مهم**: اللاعب يقدر يتنقل بين الغرف بحرية (أزرار التنقل تحت)، بس الزر "تابع" هو اللي بيحرك القصة للأمام.

## التفاصيل التقنية

### 1. إصلاح Bug الـ CTA (مشكلة routing)

**الملف**: `AnalystHubScreen.tsx` (سطر 29-38)

**المشكلة**: `handleCTA` بيقرأ `PHASES[state.currentPhaseIndex + 1]` لكن بيستخدم الـ `ctaTarget` بتاع المرحلة الجديدة بدل الحالية. يعني لما الـ phase الحالية هي 2 (ctaTarget = "dashboard")، بيعمل advance فيروح phase 3 (ctaTarget = "floor") وبيستخدم floor!

**الحل**: نقرأ `ctaTarget` من المرحلة الحالية قبل ما نعمل advance:
```text
handleCTA:
  1. target = PHASES[currentPhaseIndex].ctaTarget  // احفظ الهدف الحالي
  2. advancePhase()                                  // اتقدم
  3. toast(PHASES[currentPhaseIndex + 1].toastMessage) // اعرض رسالة المرحلة الجديدة
  4. navigate(target)                                 // روح للهدف الصح
```

### 2. إنشاء GameOverlay component جديد

**ملف جديد**: `src/components/game/GameOverlay.tsx`

هيظهر في كل الشاشات (بيانات / أدلة / صالة / مكتب) وفيه:

**فوق الشاشة**: شريط الفرضيات الأربعة المختارة (بطاقات صغيرة)

**تحت الشاشة**: أزرار التنقل بين الغرف المتاحة:
- البيانات (لو unlockedDashboard > 0)
- الأدلة (لو unlockedEvidence > 0)
- الصالة (لو unlockedInterviews > 0)
- المكتب (دايما متاح)
- غرفة التحليل (تظهر بعد المرحلة 11)

**وسط**: "Continue Banner" - زر تابع التحليل + رسالة سياقية
- يظهر فقط لما المرحلة الحالية خلصت (اللاعب شاف كل الأدلة المطلوبة)
- الرسالة من `PHASES[currentPhaseIndex].toastMessage`
- الزر بيعمل `advancePhase()` وبينقل للشاشة المطلوبة

**عرض التبديل**: بعد المرحلة 4، يظهر banner مرة واحدة:
- "تقدر تبدل فرضية واحدة لو حاسس إن اتجاهك اتغير"
- زرين: "بدّل" و "كمّل بدون تبديل"
- لو ضغط "كمّل" أو "بدّل": الـ banner يختفي ولا يظهر تاني

### 3. تعديل PHASES - رسائل السياق

**الملف**: `src/data/case1.ts`

تعديل `toastMessage` لكل مرحلة ليكون سياقي مش hint:

| المرحلة | الرسالة الحالية | الرسالة الجديدة |
|---|---|---|
| 2 (بعد البيانات) | "ممكن تقابل فريق العمل..." | "خالد ونورة موجودين في الصالة... ممكن يكون عندهم ملاحظات" |
| 3 (بعد الصالة) | "اتفتح ملف جديد في غرفة الأدلة" | "اتفتح ملف جديد في غرفة الأدلة" |
| 4 (بعد K6) | "تقدر تبدل فرضية..." | (يتعامل معاه الـ swap UI مش toast) |
| 5 (بعد K1+K3) | "في بيانات أدق ممكن تفيدك" | "ظهر تقرير جديد في غرفة البيانات" |
| 6 (بعد K2) | "في نقطة عن ضغط الكاشير..." | "ظهرت بيانات جديدة في غرفة البيانات" |
| 7 (بعد D3) | "في تقرير تسوية..." | "اتفتح ملف جديد في غرفة الأدلة" |
| 8 (بعد K5) | "في ورقة بتوضح بعد البيع..." | "اتفتح مستند جديد في غرفة الأدلة" |
| 9 (بعد K4) | "معلومة من زبونة..." | "فيه حد في الصالة عايز يقولك حاجة" |
| 10 (بعد الزبونة) | -- | "خلصت جمع الأدلة... روح غرفة التحليل وابدأ المصفوفة" |

وأيضا إضافة `ctaMessage` لكل مرحلة (الجملة اللي تظهر فوق زر التابع):

| المرحلة | ctaMessage |
|---|---|
| 2 | "ابدأ بالبيانات، خد فكرة عامة عن اللي اتغير الأسبوع ده" |
| 3 | "خالد ونورة موجودين في الصالة" |
| 4 | "اتفتح ملف جديد في غرفة الأدلة" |
| 5 | "فيه مستندات تانية اتفتحت في غرفة الأدلة" |
| 6 | "ظهر تقرير جديد في غرفة البيانات" |
| 7 | "ظهرت بيانات جديدة في غرفة البيانات" |
| 8 | "اتفتح ملف جديد في غرفة الأدلة" |
| 9 | "اتفتح مستند جديد في غرفة الأدلة" |
| 10 | "فيه حد في الصالة عايز يقولك حاجة" |
| 11 | "خلصت جمع الأدلة... روح غرفة التحليل" |

### 4. تعديل HypothesisSelectScreen

**الملف**: `src/components/game/screens/HypothesisSelectScreen.tsx`

بعد اختيار 4 فرضيات والضغط على "ابدأ التحليل":
- بدل ما يروح للـ Hub، يروح direct على غرفة البيانات
- يعمل advancePhase() مرتين (0->1->2) عشان يفتح D1+D2
- الـ flow: hypothesis-select -> dashboard (مباشرة)

### 5. تعديل كل شاشات الغرف

كل شاشة (DashboardScreen, EvidenceScreen, FloorScreen, OfficeScreen) هتتعدل:

**إزالة**: زر "مركز التحليل" من تحت كل شاشة
**إضافة**: GameOverlay component بدله

الـ GameOverlay هيحتوي:
- شريط الفرضيات فوق
- أزرار الغرف تحت
- زر "تابع التحليل" + رسالة (يظهر لما المرحلة تخلص)

**متى يظهر زر "تابع"؟**
- لما اللاعب يكون في الشاشة الصح ويكون شاف كل الأدلة المطلوبة في المرحلة الحالية
- مثلا في المرحلة 2 (D1+D2): لما يكون في غرفة البيانات وشاف D1 وD2

### 6. إصلاح UI Freeze

**الملف**: `src/components/game/EnhancedDialogue.tsx`

المشكلة الأساسية: الـ `AnimatePresence` جوا الـ `EnhancedDialogue` بيعمل `fixed inset-0 z-40` backdrop. لما الـ component يتشال من الـ DOM، الـ backdrop بيفضل.

**الحل**: 
- الـ `EnhancedDialogue` ما يعملش backdrop خاص بيه
- الـ backdrop يكون مسؤولية الـ parent (اللي هو `OfficeScreen`) وده بيحصل أصلا بالـ `AnimatePresence` wrapper
- نشيل الـ `<motion.div className="fixed inset-0 z-40">` من جوا EnhancedDialogue
- ونخلي الـ z-index بتاع الـ dialogue box نفسه يكون عالي بدون backdrop منفصل

### 7. AnalystHubScreen يتحول لـ AnalysisRoom

بدل ما يكون صفحة UI، يتحول لغرفة تحليل:
- فيها background image (analysis-lab)
- فيها hotspots: الدفتر، المصفوفة، الفرضيات
- فيها الـ GameOverlay زي باقي الغرف
- تظهر فقط لما المرحلة توصل 11 (وقت المصفوفة)
- قبل كده، اللاعب ما بيحتاجش يروحها - كل حاجة موزعة

### 8. تعديل Index.tsx

- بعد hypothesis-select -> يروح dashboard مش analyst-hub
- الـ analyst-hub يتحول لـ analysis (غرفة التحليل)
- شيل analyst-hub من الـ screens أو خليه كـ alias للـ analysis

## ملخص الملفات

| الملف | التعديل |
|---|---|
| `src/data/case1.ts` | تعديل PHASES: إضافة ctaMessage، تعديل toastMessage |
| `src/components/game/GameOverlay.tsx` | **جديد**: شريط فرضيات + أزرار غرف + زر تابع + swap UI |
| `src/components/game/EnhancedDialogue.tsx` | إصلاح: شيل الـ backdrop الداخلي |
| `src/components/game/screens/HypothesisSelectScreen.tsx` | تعديل: يروح dashboard بدل analyst-hub |
| `src/components/game/screens/DashboardScreen.tsx` | تعديل: يستخدم GameOverlay بدل NavigationButton |
| `src/components/game/screens/EvidenceScreen.tsx` | تعديل: يستخدم GameOverlay |
| `src/components/game/screens/FloorScreen.tsx` | تعديل: يستخدم GameOverlay |
| `src/components/game/screens/OfficeScreen.tsx` | تعديل: يستخدم GameOverlay |
| `src/components/game/screens/AnalystHubScreen.tsx` | تعديل كبير: يتحول لغرفة تحليل (المصفوفة) |
| `src/pages/Index.tsx` | تعديل: flow بعد hypothesis-select يروح dashboard |
| `src/components/game/FloatingNotebook.tsx` | إضافة: Activity Log (سجل الإجراءات) |
