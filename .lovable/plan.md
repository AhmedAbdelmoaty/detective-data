
# خطة التنفيذ الكاملة - إعادة بناء القضية (9 مراحل)

## نظرة عامة

إعادة بناء كاملة للعبة بسيناريو جديد (Fashion House - مرتجعات/خصومات بعد البيع) مع flow خطي من 9 مراحل، 4 مشاهد افتتاحية، 8 فرضيات (يختار منها 4)، 14 دليل (11 حقيقي + 3 ضوضاء)، ودفتر ملاحظات عائم.

---

## ترتيب التنفيذ (8 خطوات)

### الخطوة 1: `src/data/case1.ts` - إعادة كتابة كاملة

**المحتوى الجديد:**

**CASE_INFO** - تحديث العنوان والوصف:
- العنوان: "قضية Fashion House"
- الوصف: "صاحب محل ملابس لاحظ إن صافي المبيعات أقل من المتوقع رغم إن الحركة موجودة"
- التاريخ: السبت 21 فبراير 2026

**HYPOTHESES (8):**
- H1: الزباين بقت تشتري أقل (سلة شراء أصغر)
- H2: منافس قريب بيسحب جزء من الشراء
- H3 (صحيح): مرتجعات/خصومات/تعديلات بعد البيع - `isCorrect: true`
- H4: أخطاء/تعطيل في التسجيل وقت الذروة
- H5: الموسم هادي والطلب أضعف
- H6: نقص مقاسات/مخزون
- H7: الأسعار مش مناسبة
- H8: سرقة/تلف ملحوظ

**SCENES (4 مشاهد أبو سعيد)** - array جديد `INTRO_SCENES`:
- كل مشهد = `{ id, backgroundImage (placeholder حاليا), dialogues[] }`
- المشهد 1: التقديم - "الأرقام مش مريحة" (صورة: الكاشير)
- المشهد 2: التفاصيل - "الرقم أقل من اللي في دماغي" (صورة: ورق مطبوع)
- المشهد 3: السياق - "الأسعار زي ما هي... شحنة اتفرشت" (صورة: الرفوف)
- المشهد 4: التلخيص - "كل التفسيرات شكلها منطقي" (صورة: الكاشير تاني)
- كل dialogue فيه `isSaveable` على بعض الجمل المهمة

**EVIDENCE_ITEMS (9 items في Evidence Room):**

| ID | الاسم | النوع | المحتوى |
|---|---|---|---|
| K1 | سجل الأسعار | table | 6 أصناف + آخر تعديل (كلهم 2025-11) + "لا تعديلات من 3 شهور" |
| K2 | القطع المباعة حسب الصنف | table | 6 أصناف مقارنة أسبوعين (أرقام متقاربة: 120->116, 74->73...) |
| K3 | بروشور المنافس | brochure | "خصومات شتوية - خصم لحد 40% على مختارات" |
| K4 | ملخص بعد البيع | table | مرتجعات: 14->27, قيمة: 2900->6500, خصومات: 3600->4200 |
| K5 | تسوية المدفوعات POS | table | 3 أيام: فرق 0, 1, 0 |
| K6 | ملف المخزون + الجرد | document (صفحتين) | شحنة 12 فبراير كاملة + جرد 20 فبراير: نقص=0, تالف=2 |
| N1 | بوست سوشيال | note | "المحل ده مراياته حلوة" + تفاعل |
| N2 | دفتر شكاوى | note | ملاحظات متفرقة: "زحمة العصر", "قياس كتير" |
| N3 | إيصال طلب خاص | note | تاريخ 10 فبراير, 8500 جنيه |

**DASHBOARD_DATA (4 items في Data Room):**

| ID | الاسم | النوع | المحتوى |
|---|---|---|---|
| D1 | صافي المبيعات | bar | أسبوعين: 92,400 vs 78,600 |
| D2 | عدد الفواتير يوميا | line | 15 يوم (86,88,84,90,87,85,89,83,86,87,82,88,84,86,83) |
| D3 | توزيع الفواتير بالساعة | bar | ذروة 6-8م (22) و 8-10م (20) |
| K2 | القطع المباعة (يظهر في Data Room) | table | نفس K2 من فوق |

**ملاحظة**: K2 بيظهر في Data Room (المرحلة 5) مش Evidence Room

**CHARACTERS** - تعديل الحوارات:

| الشخصية | النص الجديد |
|---|---|
| خالد (I1) | "بحس الناس بتقيس موديلات كتير... بس بالآخر بتطلع بحاجة أقل" + سؤال اختياري |
| نورة (I2) | "الضغط بيزيد آخر اليوم... ساعات الجهاز يبطأ... بنعيد المحاولة" + سؤال اختياري |
| الزبونة/أميرة (I3) | "العروض على موديلات محددة... وشرط حد أدنى... مش زي الإعلان" |

**PHASES** - array جديد يحدد ترتيب المراحل:

```text
المرحلة 0: scenes (مشاهد أبو سعيد)
المرحلة 1: hypothesis-select (اختيار 4 من 8)
المرحلة 2: data (D1 + D2)
المرحلة 3: floor (خالد + نورة)
المرحلة 4: evidence-early (K6 فقط + فرصة تبديل)
المرحلة 5: evidence-mid (K1 + K3)
المرحلة 6: data-mid (K2 - قفل H1)
المرحلة 7: data-evidence (D3 - إغراء H4)
المرحلة 8: evidence-late (K5 - قفل H4)
المرحلة 9: evidence-final (K4 - تقوية H3)
المرحلة 10: floor-late (الزبونة - تضعيف H2)
المرحلة 11: matrix (المصفوفة + الاختيار النهائي)
```

**ملاحظة مهمة عن الترتيب**: فصلت D3 (إغراء H4) عن K5 (قفل H4) في مرحلتين منفصلتين (7 و 8) عشان اللاعب يعيش مع الإغراء شوية قبل ما ينفيه.

**الضوضاء (N1, N2, N3)**: تظهر في Evidence Room من المرحلة 4 فصاعدا (متاحة بس مش مطلوبة)

**REFERENCE_MATRIX (14x8)** - بالظبط زي ما في السيناريو:

```text
         H1   H2   H3   H4   H5   H6   H7   H8
D1        +    +    +    +    +    +    +    +
D2        -    +    +    +    -    +    +    +
D3        +    +    +   ++    -    +    +    +
K1        +    +    +    +    +    +   --    +
K2       --    +    +    +    -    +    +    +
K3        +   ++    +    +    +    +    +    +
K4        -    -   ++    -    +    +    +    +
K5        +    +    +   --    +    +    +    +
K6        +    +    +    +    +   --    +   --
I1        +    +    +    +    +    +    +    +
I2        +    +    +   ++    +    +    +    +
I3        +    -    +    +    +    +    +    +
N1-N3     +    +    +    +    +    +    +    +
```

**DIAGNOSTIC_EVIDENCE_IDS**: `["K4", "K2", "I3"]`

**ENDINGS** - تعديل النصوص للسيناريو الجديد (المرتجعات بدل البيع بدون تسجيل)

---

### الخطوة 2: `src/contexts/GameContext.tsx` - تعديلات جوهرية

**GameState الجديد:**
```text
+ currentPhaseIndex: number (0-11)
+ unlockedEvidence: string[]
+ unlockedDashboard: string[]
+ unlockedInterviews: string[]
+ hasUsedSwap: boolean
+ matrixEvidence: string[] (أدلة اللاعب أضافها للمصفوفة يدويا)
- تعديل NotebookEntry.source ليشمل "story"
- تعديل currentPhase ليشمل "scenes" | "hypothesis-select" | "analyst-hub"
```

**Functions جديدة:**
- `advancePhase()` - ينقل للمرحلة التالية + يفتح الأدلة المناسبة + يطلق toast
- `swapHypothesis(oldId, newId)` - تبديل فرضية واحدة (مرة واحدة فقط)
- `addToMatrix(sourceId)` - إضافة دليل من الدفتر للمصفوفة
- `removeFromMatrix(sourceId)` - حذف دليل من المصفوفة
- `getUnlockedForPhase(phaseIndex)` - يرجع الأدلة المفتوحة لمرحلة معينة
- `getCTALabel()` - يرجع نص زر CTA بناء على المرحلة الحالية
- `getCTATarget()` - يرجع الشاشة اللي CTA هينقل ليها

**منطق advancePhase:**
- المرحلة 2: يفتح D1, D2 + N1, N2 (ضوضاء)
- المرحلة 3: يفتح خالد, نورة
- المرحلة 4: يفتح K6 + N3
- المرحلة 5: يفتح K1, K3
- المرحلة 6: يفتح K2 (في Data Room)
- المرحلة 7: يفتح D3
- المرحلة 8: يفتح K5
- المرحلة 9: يفتح K4
- المرحلة 10: يفتح الزبونة/أميرة

**منطق النهاية:**
- تعديل `setFinalHypothesis` للسيناريو الجديد (H3 = مرتجعات)
- `DIAGNOSTIC_EVIDENCE_IDS = ["K4", "K2", "I3"]`

---

### الخطوة 3: شاشات جديدة (4 ملفات)

#### 3A: `src/components/game/screens/ScenesScreen.tsx`
- يعرض المشاهد الـ 4 بالتتابع
- كل مشهد = صورة خلفية (placeholder حاليا: نستخدم الصور الموجودة store-front.png و detective-office.png بالتبادل) + حوار EnhancedDialogue
- بعد كل مشهد: fade transition للمشهد التالي
- بعد المشهد 4: انتقال تلقائي لشاشة اختيار الفرضيات
- كل dialogue saveable في الدفتر
- لا يمكن إغلاق المشاهد بالـ click-outside (أول مرة)

#### 3B: `src/components/game/screens/HypothesisSelectScreen.tsx`
- عنوان: "إيه التفسيرات الأقرب؟"
- نص: "قبل ما تبدأ تجمع أدلة... اختر 4 تفسيرات تحسها الأقرب من اللي سمعته"
- 8 بطاقات في grid (2 أعمدة)
- كل بطاقة: رقم + عنوان + وصف قصير + زر اختيار
- عداد: X/4 مختارة
- زر "ابدأ التحليل" يظهر بعد اختيار 4
- نص تحت: "اختيارك مبدئي... بعد أول مجموعة أدلة تقدر تبدل فرضية واحدة"

#### 3C: `src/components/game/screens/AnalystHubScreen.tsx`
- الشاشة المركزية (تحل محل AnalysisScreen القديمة)
- **فوق**: بطاقات الفرضيات المختارة (4) - صغيرة وملونة
- **وسط**: ملخص القضية (mini card) + عداد التقدم
- **CTA ديناميكي**: زر كبير "تابع التحليل -> [اسم المحطة]"
  - المرحلة 2: "ابدأ من البيانات"
  - المرحلة 3: "تابع -> الصالة"
  - المرحلة 4: "تابع -> غرفة الأدلة"
  - المرحلة 5: "تابع -> مستندات المنافس والأسعار"
  - المرحلة 6: "تابع -> بيانات أدق"
  - المرحلة 7: "تابع -> ضغط الكاشير"
  - المرحلة 8: "تابع -> تسوية المدفوعات"
  - المرحلة 9: "تابع -> ورقة بعد البيع"
  - المرحلة 10: "تابع -> رأي زبونة"
  - المرحلة 11: "افتح المصفوفة"
- **زر تبديل**: يظهر مرة واحدة بعد المرحلة 4 (`hasUsedSwap === false`)
- **أزرار تنقل**: للأماكن المتاحة (data/evidence/floor)

#### 3D: `src/components/game/screens/FloorScreen.tsx`
- بديل InterrogationScreen
- يعرض فقط الشخصيات اللي في `unlockedInterviews`
- باقي الشخصيات مقفولة (أيقونة قفل)
- نفس المنطق: ضغط على الشخصية -> EnhancedDialogue
- صور placeholder حاليا (نستخدم interrogation-room.png كخلفية)
- بعد إكمال كل مقابلة -> toast + يرجع للـ Analyst Hub

---

### الخطوة 4: `src/components/game/FloatingNotebook.tsx` - جديد

- زر floating في أسفل يمين الشاشة (ظاهر في كل مكان ما عدا intro/onboarding/scenes)
- يعرض عدد الملاحظات على الزر (badge)
- عند الضغط: يفتح panel/modal جانبي فيه:
  - قائمة الملاحظات مع مصدرها (قصة/دليل/مقابلة/داشبورد)
  - زر حذف لكل ملاحظة
  - ملخص القضية (expandable)
- يستخدم `useGame()` مباشرة

---

### الخطوة 5: تعديل `src/components/game/screens/EvidenceScreen.tsx`

- بدل ما يعرض كل الأدلة، يعرض فقط اللي في `state.unlockedEvidence`
- الأدلة المقفولة تظهر بأيقونة قفل + لون باهت
- 9 أدلة بدل 7 (K1-K6 + N1-N3)
- تعديل `renderEvidenceContent` لأنواع الأدلة الجديدة:
  - K5: جدول POS (3 صفوف بسيطة)
  - K6: document بصفحتين (tab أو scroll)
  - N1: screenshot سوشيال
  - N2: دفتر ملاحظات
  - N3: إيصال
- بعد مشاهدة كل الأدلة المفتوحة في المرحلة: toast "ارجع لمركز التحليل"
- Hotspots جديدة (9 مواقع) - نحط إحداثيات مبدئية وبعدين نظبط

---

### الخطوة 6: تعديل `src/components/game/screens/DashboardScreen.tsx`

- يعرض فقط اللي في `state.unlockedDashboard`
- 4 items بدل 3 (D1, D2, D3, K2)
- D2 = Line Chart (جديد) بدل الـ table القديم
- K2 = جدول مقارنة أصناف (يظهر في المرحلة 6)
- تعديل Hotspots (4 مواقع)
- نفس المنطق: بعد المشاهدة -> toast

---

### الخطوة 7: تعديل الشاشات القائمة

#### `src/pages/Index.tsx`
- إضافة الشاشات الجديدة: scenes, hypothesis-select, analyst-hub, floor
- تعديل Screen type
- تعديل Flow:
```text
intro -> onboarding -> scenes -> hypothesis-select -> analyst-hub
-> (data | evidence | floor) -> analyst-hub (دايما يرجع)
-> matrix (من analyst-hub) -> result
```

#### `src/components/game/screens/OfficeScreen.tsx`
- تعديل لـ "مكتب أبو سعيد" كمكان إعادة المشاهد
- إضافة زر "إعادة مشاهد البداية"
- إزالة المنطق القديم (intro dialogue في المكتب)
- إزالة أزرار التنقل القديمة (التنقل من الـ Hub)

#### `src/components/game/screens/OnboardingScreen.tsx`
- تعديل المحتوى ليتوافق مع السيناريو الجديد (Fashion House بدل "متجر ملابس")
- تعديل شرح الغرف والخطوات

#### `src/components/game/screens/IntroScreen.tsx`
- تعديل بسيط للعنوان والوصف

#### `src/components/game/screens/ResultScreen.tsx`
- تعديل النصوص للسيناريو الجديد
- تعديل stats لتشمل المراحل الجديدة

---

### الخطوة 8: تعديل `AnalysisScreen.tsx` -> `MatrixScreen.tsx`

- إعادة تسمية أو إنشاء شاشة مصفوفة مستقلة
- المصفوفة فيها فقط الأدلة اللي اللاعب أضافها يدويا من الدفتر
- زر "أضف دليل للمصفوفة" -> يفتح قائمة من الدفتر
- زر "احذف دليل من المصفوفة"
- بعد ملء كل الخلايا: يظهر قسم اختيار الفرضية النهائية
- بعد الاختيار: انتقال لشاشة النتيجة

---

## ملاحظات مهمة

### الصور
- المشاهد (4): حاليا نستخدم الصور الموجودة بالتبادل (store-front.png, detective-office.png, intro-character.png)
- شخصيات المقابلات: نستخدم AnimatedCharacter الموجود (khaled, noura, umFahd)
- أدلة المستندات: نعرضها كـ UI (جداول/كروت) - مش صور
- كل الصور الحقيقية هتتعمل لاحقا بـ prompts مخصصة

### الدفتر العائم
- ظاهر في كل الشاشات ما عدا intro/onboarding/scenes/result
- يحفظ من أي مكان: مشاهد، أدلة، مقابلات، داشبورد
- المصفوفة: اللاعب يختار يدويا أي أدلة من الدفتر يدخلها

### ملخص القضية
- متاح في الدفتر العائم (expandable section)
- يحتوي على: عنوان القضية + الوصف + التاريخ + "فيه انخفاض في صافي المبيعات رغم حركة موجودة"

### تبديل الفرضية
- يظهر مرة واحدة بعد المرحلة 4 (بعد ما يشوف K6 اللي بينفي H6 و H8)
- UI: modal بسيط يختار منه الفرضية القديمة والجديدة
- بعد الاستخدام: الزر يختفي نهائيا

### Toast Messages (بدون تفاصيل)
- بعد المرحلة 2: "ممكن تقابل فريق العمل... اسمع ملاحظاتهم"
- بعد المرحلة 3: "اتفتح ملف جديد في غرفة الأدلة"
- بعد المرحلة 4: "تقدر تبدل فرضية واحدة لو حاسس إن اتجاهك اتغير"
- بعد المرحلة 5: "في بيانات أدق ممكن تفيدك"
- بعد المرحلة 7: "في نقطة عن ضغط الكاشير... شوفها"
- بعد المرحلة 8: "في تقرير تسوية... ممكن يوضح حاجة"
- بعد المرحلة 9: "في ورقة بتوضح بعد البيع... ممكن تكون مهمة"
- بعد المرحلة 10: "معلومة من زبونة ممكن توسع الصورة"

---

## حجم العمل

| الملف | الحالة | تقدير الحجم |
|---|---|---|
| `src/data/case1.ts` | إعادة كتابة كاملة | كبير جدا |
| `src/contexts/GameContext.tsx` | تعديل جوهري | كبير |
| `ScenesScreen.tsx` | جديد | متوسط |
| `HypothesisSelectScreen.tsx` | جديد | متوسط |
| `AnalystHubScreen.tsx` | جديد | كبير |
| `FloorScreen.tsx` | جديد | متوسط |
| `FloatingNotebook.tsx` | جديد | متوسط |
| `EvidenceScreen.tsx` | تعديل كبير | كبير |
| `DashboardScreen.tsx` | تعديل كبير | كبير |
| `Index.tsx` | تعديل | صغير |
| `OfficeScreen.tsx` | تعديل | متوسط |
| `OnboardingScreen.tsx` | تعديل | صغير |
| `IntroScreen.tsx` | تعديل بسيط | صغير |
| `ResultScreen.tsx` | تعديل | متوسط |
| `AnalysisScreen.tsx` -> `MatrixScreen` | تعديل/إعادة | كبير |

**الإجمالي**: ~15 ملف، هيتنفذوا بالترتيب (case1.ts اولا -> GameContext -> شاشات جديدة -> تعديلات).
